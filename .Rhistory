r_true <- (data_calib$n - mu_true[(n_train +1) : (n_train +n_calib)]) / sqrt(mu_true[(n_train +1) : (n_train +n_calib)])
r_GLM_GBM_correct <-(data_calib$n - mu_glm_correct_calib) / sqrt(phi_correct_calib * mu_glm_correct_calib)
r_GLM_1_correct <- (data_calib$n - mu_glm_correct_calib) / sqrt(mu_glm_correct_calib)
r_GLM_GBM <-(data_calib$n - mu_glm_calib) / sqrt(phi_glm_calib * mu_glm_calib)
r_GLM_1 <- (data_calib$n - mu_glm_calib) / sqrt(mu_glm_calib)
r_GBM_GBM <- (data_calib$n - mu_gbm_calib) / sqrt(phi_gbm_calib * mu_gbm_calib)
r_GBM_1 <- (data_calib$n - mu_gbm_calib) / sqrt(mu_gbm_calib)
plot_lims <- c(min(r_true, r_GLM_1, r_GLM_GBM, r_GBM_1, r_GBM_GBM, r_GLM_GBM_correct, r_GLM_1_correct),
max(r_true, r_GLM_1, r_GLM_GBM, r_GBM_1, r_GBM_GBM, r_GLM_GBM_correct, r_GLM_1_correct))
png(file = sprintf("%s%s_Pearson_GLM_GBM_correct.png", file_path_figs, base_file))
plot(r_GLM_GBM_correct, r_true, pch = 20, #xlim = plot_lims, ylim = plot_lims,
ylab = "Pearson true mu GLM, phi = 1",
xlab = "Pearson est mu GLM (correct), est phi GBM")
dev.off()
png(file = sprintf("%s%s_Pearson_GLM_phi_1_correct.png", file_path_figs, base_file))
plot(r_GLM_1_correct, r_true, pch = 20, #xlim = plot_lims, ylim = plot_lims,
ylab = "Pearson true mu GLM, phi = 1",
xlab = "Pearson est mu GLM (correct), phi = 1")
dev.off()
png(file = sprintf("%s%s_Pearson_GLM_GBM.png", file_path_figs, base_file))
plot(r_GLM_GBM, r_true, pch = 20, #xlim = plot_lims, ylim = plot_lims,
ylab = "Pearson true mu GLM, phi = 1",
xlab = "Pearson est mu GLM, est phi GBM")
# INIT
setwd("//e75a0679/sakta/UTV/SU/Program/Analys/Boosting GLM/Boosting-GLM")
source("load_packages.r")
load_packages(updateR = FALSE)
library(data.table)
setwd("//e75a0679/Sakta/EGET/b90joo/Hit Rate")
data <- fread("//e75a0679/Sakta/EGET/b90joo/Hit Rate/Hackaton_2023_03_06_PRISFORFRAGNINGAR_PRICEIT_AVTAL.csv")
str(data)
df <- data  %>% filter(M_AVTALSPERIODTYP != c(0,2)) %>% dplyr::select(c(M_BOLAG,
M_KUND_ID,
REGNR,
skapaddatum_manad,
Bruttopremie1,
Bruttopremie2,
Bruttopremie3,
TOTAL_PRISJUSTERINGBELOPPSPAVERKAN,
TOTAL_ARSNETTOPREMIE
))
df <- data  %>% filter(M_AVTALSPERIODTYP != c(0,2)) %>% dplyr::select(c(M_BOLAG,
M_KUND_ID,
REGNR,
skapaddatum_manad,
TOTAL_BRUTTOPREMIE1,
TOTAL_BRUTTOPREMIE2,
TOTAL_BRUTTOPREMIE3,
TOTAL_PRISJUSTERINGBELOPPSPAVERKAN,
TOTAL_ARSNETTOPREMIE
))
save(df, file = paste("Data.RData", sep = ""))
data_grouped <- df %>% group_by(M_KUND_ID, REGNR,skapaddatum_manad)
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
count = count() )
df <- data  %>% filter(M_AVTALSPERIODTYP != c(0,2)) %>% dplyr::select(c(M_BOLAG,
M_KUND_ID,
REGNR,
skapaddatum_manad,
TOTAL_BRUTTOPREMIE1,
TOTAL_BRUTTOPREMIE2,
TOTAL_BRUTTOPREMIE3,
TOTAL_PRISJUSTERINGBELOPPSPAVERKAN,
TOTAL_ARSNETTOPREMIE,
HARFORSAKRING
))
save(df, file = paste("Data.RData", sep = ""))
data_grouped <- df %>% group_by(M_KUND_ID, REGNR,skapaddatum_manad)
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
count = count() )
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
count = count(HARFORSAKRING) )
Hit_rates_monthly <- Harforsakring %>% ungroup() %>% group_by(M_BOLAG,skapaddatum_manad) %>% summarise(HR = mean(qoute),
Antal_nya = sum(qoute))
Harforsakring <- data_grouped %>%summarise(qoute = max(HARFORSAKRING) )
Hit_rates_monthly <- Harforsakring %>% ungroup() %>% group_by(M_BOLAG,skapaddatum_manad) %>% summarise(HR = mean(qoute),
Antal_nya = sum(qoute))
data_grouped <- df %>% group_by(M_KUND_ID, REGNR,skapaddatum_manad)
Harforsakring <- data_grouped %>%summarise(qoute = max(HARFORSAKRING) )
Harforsakring
Hit_rates_monthly <- Harforsakring %>% ungroup() %>% group_by(skapaddatum_manad) %>% summarise(HR = mean(qoute),
Antal_nya = sum(qoute))
Hit_rates_monthly
Harforsakring
df %>% left_join(data_grouped)
df_final <- df %>% left_join(Harforsakring, by = c(M_KUND_ID, REGNR,skapaddatum_manad) )
Harforsakring
df_final <- df %>% left_join(Harforsakring, by = join_by(M_KUND_ID, REGNR,skapaddatum_manad) )
df_final
df
df %>% dplyr::select(-HARFORSAKRING) %>% unique()
df_final <- df %>% dplyr::select(-HARFORSAKRING) %>% unique() %>% left_join(Harforsakring, by = join_by(M_KUND_ID, REGNR,skapaddatum_manad) )
df_final
data_grouped %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5))
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = count(HARFORSAKRING))
data_grouped
Harforsakring
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = count(HARFORSAKRING))
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = n())
Harforsakring
df_final <- df %>% dplyr::select(-HARFORSAKRING) %>% unique() %>% left_join(Harforsakring, by = join_by(M_KUND_ID, REGNR,skapaddatum_manad) )
df_final
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = n(),
Pris_just = sum(TOTAL_PRISJUSTERINGBELOPPSPAVERKAN)    )
df_final <- df %>% dplyr::select(-c(HARFORSAKRING,TOTAL_PRISJUSTERINGBELOPPSPAVERKAN)) %>% unique() %>% left_join(Harforsakring, by = join_by(M_KUND_ID, REGNR,skapaddatum_manad) )
df_final
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = n(),
Pris_just = sum(TOTAL_PRISJUSTERINGBELOPPSPAVERKAN*HARFORSAKRING)    )
data_grouped %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean(TOTAL_PRISJUSTERINGBELOPPSPAVERKAN > 0) )
Harforsakring
df_final
data_grouped %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad )
df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean(TOTAL_PRISJUSTERINGBELOPPSPAVERKAN > 0) )
df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean(Pris_just > 0) )
df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean(Pris_just > 0),
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) )
df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean( qoute*(Pris_just > 0)) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar = Antal_prisslagningar/ mean(Antal_prisslagningar))
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean( qoute*(Pris_just > 0)) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar = Antal_prisslagningar/ mean(Antal_prisslagningar))
view(FINAL_table)
view(FINAL_table %>% filter(skapaddatum_manad==15032023))
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
df <- data  %>% filter(M_AVTALSPERIODTYP != c(0,2)) %>% filter(skapaddatum_manad!= 15032023) %>% dplyr::select(c(M_BOLAG,
M_KUND_ID,
REGNR,
skapaddatum_manad,
TOTAL_BRUTTOPREMIE1,
TOTAL_BRUTTOPREMIE2,
TOTAL_BRUTTOPREMIE3,
TOTAL_PRISJUSTERINGBELOPPSPAVERKAN,
TOTAL_ARSNETTOPREMIE,
HARFORSAKRING
))
save(df, file = paste("Data.RData", sep = ""))
data_grouped <- df %>% group_by(M_KUND_ID, REGNR,skapaddatum_manad)
Harforsakring <- data_grouped %>% summarise(qoute = max(HARFORSAKRING),
sum = n(),
Pris_just = sum(TOTAL_PRISJUSTERINGBELOPPSPAVERKAN*HARFORSAKRING)    )
df_final <- df %>% dplyr::select(-c(HARFORSAKRING,TOTAL_PRISJUSTERINGBELOPPSPAVERKAN)) %>%
unique() %>%
left_join(Harforsakring, by = join_by(M_KUND_ID, REGNR,skapaddatum_manad) )
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean( qoute*(Pris_just > 0)) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar = Antal_prisslagningar/ mean(Antal_prisslagningar))
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering = mean( qoute*(Pris_just > 0)) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar = percent(Antal_prisslagningar/ mean(Antal_prisslagningar) ))
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering =  percent(mean( qoute*(Pris_just > 0))) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar =Antal_prisslagningar/ mean(Antal_prisslagningar) )
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering =  percent(mean( qoute*(Pris_just > 0)),2) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar =Antal_prisslagningar/ mean(Antal_prisslagningar) )
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
FINAL_table <- df_final %>% ungroup() %>% mutate(Riskgroup = ntile(TOTAL_BRUTTOPREMIE1,5)) %>% group_by(Riskgroup,skapaddatum_manad ) %>%
summarise(Antal_nya_avtal = sum(qoute),
Antal_prisslagningar = sum(sum),
Prisjustering =  percent(mean( qoute*(Pris_just > 0)), 0.01) ,
Riskprocent = mean(TOTAL_ARSNETTOPREMIE/TOTAL_BRUTTOPREMIE1) ) %>%
ungroup() %>% group_by(Riskgroup) %>%
mutate(Antal_nya_avtal = Antal_nya_avtal /mean(Antal_nya_avtal) ,
Antal_prisslagningar =Antal_prisslagningar/ mean(Antal_prisslagningar) )
view(FINAL_table %>% filter(skapaddatum_manad==15022023))
# INIT
setwd("//e75a0679/sakta/UTV/SU/Program/Analys/Boosting GLM/Boosting-GLM")
